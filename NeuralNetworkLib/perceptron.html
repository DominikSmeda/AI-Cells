<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        canvas {
            border: 2px solid black;
        }
    </style>

    <script src="./NeuralNet.js"></script>
</head>

<body>


    <canvas id="canvas" width="900" height="900"></canvas>


    <script>
        Number.prototype.map = function (in_min, in_max, out_min, out_max) {
            return (this - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
        }
        const width = 900;
        const height = 900;
        const ctx = document.getElementById('canvas').getContext('2d');
        ctx.transform(1, 0, 0, -1, width / 2, height / 2)

        const learningRate = 0.0001;
        function f(x) {
            return 1 / 2 * x - 20;
        }

        class Point {
            constructor(check = false) {
                this.x = Math.random() * width - width / 2;
                this.y = Math.random() * height - height / 2;
                this.label = f(this.x) > this.y ? 1 : -1;

                this.correct = false;
                this.check = check;
            }

            update() {

                this.show();
            }

            show() {
                ctx.save();

                if (this.label == 1) {
                    ctx.strokeStyle = "black"
                }
                else {
                    ctx.strokeStyle = "white"
                }

                if (this.correct) {
                    ctx.fillStyle = "blue"
                }
                else {
                    ctx.fillStyle = "red"
                }


                ctx.lineWidth = 3;
                ctx.strokeRect(this.x - 2, this.y - 2, 5, 5);
                ctx.fillRect(this.x - 1, this.y - 1, 3, 3);

                if (this.check) {

                    ctx.lineWidth = 1;
                    ctx.strokeStyle = "green"
                    ctx.strokeRect(this.x - 4, this.y - 4, 9, 9);
                }
                ctx.restore();

            }
        }


        class Perceptron {
            constructor() {
                this.weights = [];
                this.bias;
                this.initRandomWeights(2)
            }

            initRandomWeights(amount) {
                for (let i = 0; i < amount; i++) {
                    this.weights.push(Math.random() * 2 - 1)
                }
                this.bias = Math.random() * 2 - 1;
            }

            guess(inputs) {

                if (inputs.length != this.weights.length) {
                    console.log('error');
                    throw new Error('Different amount of inputs and weights')
                    return
                }
                let sum = 0;

                for (let i = 0; i < this.weights.length; i++) {
                    sum += inputs[i] * this.weights[i];
                }
                sum += this.bias;

                // let output = this.activationFun(sum)

                return this.activationFun(sum);

            }

            activationFun(sum) {
                return Math.sign(sum)
            }

            train(inputs, label) {
                let guess = this.guess(inputs);
                let error = label - guess;

                for (let i = 0; i < this.weights.length; i++) {
                    this.weights[i] += error * inputs[i] * learningRate;
                }
                this.bias += error * learningRate * 1000;

                return guess;
            }

            show() {
                console.log(this.weights, this.bias);
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(-width / 2, (-this.weights[0] * (-width / 2) / this.weights[1]) - (this.bias / this.weights[1]));
                ctx.strokeStyle = "blue";
                ctx.lineTo(width / 2, (-this.weights[0] * (width / 2) / this.weights[1]) - (this.bias / this.weights[1]));
                ctx.stroke();

                ctx.restore();
            }
        }


        // var p = new Perceptron();
        class Main {
            constructor() {
                this.trainSet = []
                this.testSet = [];

                this.perceptron = new Perceptron();
                this.init();
            }

            init() {
                this.loop();
            }

            createTrainSet(amount) {
                let newTrainSet = [];
                for (let i = 0; i < amount; i++) {
                    newTrainSet.push(new Point())
                }
                return newTrainSet;
            }

            teach() {
                let points = this.createTrainSet(10)
                for (let point of points) {
                    if (this.perceptron.train([point.x, point.y], point.label) == point.label) {
                        point.correct = true;
                        // console.log('good during training');
                    }
                    this.trainSet.push(point)
                }

            }

            loop() {

                ctx.save();
                ctx.clearRect(-width, -height, width * 2, height * 2)

                ctx.beginPath();
                ctx.moveTo(-width / 2, f(-width / 2));
                ctx.strokeStyle = "#AAAAAA";
                ctx.lineTo(width / 2, f(width / 2));
                ctx.stroke();

                this.perceptron.show();
                ctx.fillRect(0, 0, 3, 3);
                ctx.restore();

                // for (let obj of this.trainSet) {
                //     obj.update();
                // }

                for (let obj of this.testSet) {
                    obj.update();
                }
                // ctx.drawImage(video, 0, 0, width, height)
                requestAnimationFrame(() => {
                    this.loop()
                });


            }

            test() {
                let testPoint = new Point(true);
                this.testSet.push(testPoint);

                let g = this.perceptron.guess([testPoint.x, testPoint.y])

                if (g == testPoint.label) {
                    testPoint.correct = true;
                }
            }
        }

        let main = new Main();

        window.addEventListener('keydown', (e) => {

            if (e.key == "Enter") {
                console.log('test');
                main.test()
                main.test()
                main.test()
                main.test()
                main.test()
            }
            if (e.key == " ") {
                console.log('teach');
                main.teach()

            }

        })


    </script>

</body>

</html>