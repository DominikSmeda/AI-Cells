<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Cells</title>

    <style>
        * {
            box-sizing: border-box;
        }

        canvas {
            margin-top: 100px;
            border: 1px solid black;
            display: block;
            margin: 0 auto;

            image-rendering: crisp-edges;
            /* image-rendering: pixelated; */
        }
    </style>
</head>

<body>

    <div>
        <canvas id="root" width="900" height="900"></canvas>
    </div>


    <!-- <script src="./GameManager.js"></script> -->

    <script type="module">

        // alert();
        var KEYS = {};
        window.addEventListener('keydown', e => {
            KEYS[e.key] = true;
        })
        window.addEventListener('keyup', e => {
            KEYS[e.key] = false;
        })

        const width = 920, height = 900;
        ctx = document.getElementById('root').getContext('2d');

        import { Engine2D, Circle, Vector, Line, RayCast, Shapes } from './PhysicsEngine2DLib/main.js';
        import GameManager from './GameManager.js';
        import Cell from './Cell.js';
        import Neuroevolution from './Neuroevolution.js';

        const game = new GameManager();
        game.setCanvasSize(width, height);
        game.setCtx(ctx);


        // let line = new Line(0, 0, 0, height, 0.5, 'black');
        // game.addObject(line);
        // let line2 = new Line(0, 0, width, 0, 0.5, 'black');
        // game.addObject(line2);
        // let line3 = new Line(width, 0, width, height, 0.5, 'black');
        // game.addObject(line3);
        // let line4 = new Line(0, height, width, height, 0.5, 'black');
        // game.addObject(line4);

        // let lines = [
        //     // [0, height - 115, width, height - 115],
        //     [160, height - 100, width - 250, height - 100],
        //     //
        //     [160, 600, 400, 600],
        //     [700, 160, 280, 190],
        //     [0, 150, 600, 150, 0.97],
        //     [width, 600, 500, 700],
        //     [160, 300, 160, height - 100]
        // ]
        // for (let line of lines) {
        //     game.addObject(new Line(line[0], line[1], line[2], line[3], line[4], line[5]));
        // }

        let mapData = `{"name":"","lines":[[0,0,150,0],[0,0,0,150],[150,0,150,150],[0,150,0,300],[150,150,150,300],[0,300,0,450],[150,300,150,450],[0,450,0,600],[150,450,150,600],[0,600,0,750],[150,600,150,750],[0,900,150,900],[0,750,0,900],[150,750,300,750],[150,900,300,900],[300,0,450,0],[300,0,300,150],[300,150,300,300],[450,150,450,300],[300,300,300,450],[450,300,450,450],[300,450,300,600],[450,450,450,600],[300,600,300,750],[450,600,450,750],[300,900,450,900],[450,750,450,900],[450,0,600,0],[450,150,600,150],[600,0,750,0],[750,0,750,150],[600,150,600,300],[750,150,750,300],[600,300,600,450],[750,300,750,450],[600,450,600,600],[750,450,750,600],[600,600,600,750],[750,600,750,750],[600,900,750,900],[600,750,600,900],[750,750,900,750],[750,900,900,900],[900,750,900,900]],"width":6,"height":6,"size":150,"squares":[{"x":75,"y":75},{"x":75,"y":225},{"x":75,"y":375},{"x":75,"y":525},{"x":75,"y":675},{"x":75,"y":825},{"x":225,"y":825},{"x":375,"y":825},{"x":375,"y":675},{"x":375,"y":525},{"x":375,"y":375},{"x":375,"y":225},{"x":375,"y":75},{"x":525,"y":75},{"x":675,"y":75},{"x":675,"y":225},{"x":675,"y":375},{"x":675,"y":525},{"x":675,"y":675},{"x":675,"y":825},{"x":825,"y":825}]}`;
        // let mapData = '{"name":"","lines":[[0,0,150,0],[0,0,0,150],[150,0,150,150],[0,150,0,300],[150,150,150,300],[0,450,150,450],[0,300,0,450],[150,300,300,300],[150,450,300,450],[300,300,450,300],[450,300,450,450],[300,450,300,600],[450,450,450,600],[300,750,450,750],[300,600,300,750],[450,0,600,0],[450,0,450,150],[450,300,600,300],[450,150,450,300],[450,600,600,600],[450,750,600,750],[600,0,750,0],[600,150,750,150],[600,150,750,150],[750,150,750,300],[600,300,600,450],[750,300,750,450],[600,450,600,600],[750,450,750,600],[600,750,750,750],[750,600,750,750],[750,0,900,0],[750,150,900,150],[900,0,900,150]],"width":6,"height":6,"size":150,"squares":[{"x":75,"y":75},{"x":75,"y":225},{"x":75,"y":375},{"x":225,"y":375},{"x":375,"y":375},{"x":375,"y":525},{"x":375,"y":675},{"x":525,"y":675},{"x":675,"y":675},{"x":675,"y":525},{"x":675,"y":375},{"x":675,"y":225},{"x":525,"y":225},{"x":525,"y":75},{"x":675,"y":75},{"x":825,"y":75}]}';
        // let mapData = '{"name":"","lines":[[0,0,112.5,0],[0,0,0,112.5],[112.5,0,112.5,112.5],[0,112.5,0,225],[112.5,112.5,112.5,225],[0,337.5,112.5,337.5],[0,225,0,337.5],[0,450,112.5,450],[0,450,0,562.5],[0,562.5,0,675],[112.5,562.5,112.5,675],[0,787.5,112.5,787.5],[0,675,0,787.5],[112.5,225,225,225],[112.5,337.5,225,337.5],[112.5,450,225,450],[112.5,562.5,225,562.5],[112.5,675,225,675],[112.5,787.5,225,787.5],[225,225,337.5,225],[337.5,225,337.5,337.5],[225,337.5,225,450],[337.5,337.5,337.5,450],[225,562.5,337.5,562.5],[337.5,450,337.5,562.5],[225,675,337.5,675],[337.5,675,337.5,787.5],[225,900,337.5,900],[225,787.5,225,900],[337.5,787.5,450,787.5],[337.5,900,450,900],[450,225,562.5,225],[450,225,450,337.5],[450,337.5,450,450],[562.5,337.5,562.5,450],[450,450,450,562.5],[562.5,450,562.5,562.5],[450,675,562.5,675],[450,562.5,450,675],[450,787.5,562.5,787.5],[450,900,562.5,900],[562.5,225,675,225],[562.5,337.5,675,337.5],[562.5,562.5,675,562.5],[562.5,675,675,675],[562.5,787.5,675,787.5],[562.5,900,675,900],[675,225,787.5,225],[787.5,225,787.5,337.5],[675,450,787.5,450],[675,337.5,675,450],[675,562.5,787.5,562.5],[787.5,562.5,787.5,675],[675,675,675,787.5],[787.5,675,787.5,787.5],[675,900,787.5,900],[787.5,787.5,787.5,900],[787.5,337.5,900,337.5],[787.5,450,900,450],[900,337.5,900,450]],"width":"8","height":"8","size":112.5,"squares":[{"x":56.25,"y":56.25},{"x":56.25,"y":168.75},{"x":56.25,"y":281.25},{"x":168.75,"y":281.25},{"x":281.25,"y":281.25},{"x":281.25,"y":393.75},{"x":281.25,"y":506.25},{"x":168.75,"y":506.25},{"x":56.25,"y":506.25},{"x":56.25,"y":618.75},{"x":56.25,"y":731.25},{"x":168.75,"y":731.25},{"x":281.25,"y":731.25},{"x":281.25,"y":843.75},{"x":393.75,"y":843.75},{"x":506.25,"y":843.75},{"x":618.75,"y":843.75},{"x":731.25,"y":843.75},{"x":731.25,"y":731.25},{"x":731.25,"y":618.75},{"x":618.75,"y":618.75},{"x":506.25,"y":618.75},{"x":506.25,"y":506.25},{"x":506.25,"y":393.75},{"x":506.25,"y":281.25},{"x":618.75,"y":281.25},{"x":731.25,"y":281.25},{"x":731.25,"y":393.75},{"x":843.75,"y":393.75}]}';
        mapData = JSON.parse(mapData);

        for (let pos of mapData.lines) {
            let line = new Line(pos[0], pos[1], pos[2], pos[3], 0.5, 'black');
            game.addObject(line)
        }

        for (let i = 0; i < mapData.squares.length; i++) {
            let square = mapData.squares[i];

            let rect = new Shapes.Rectangle(square.x, square.y, mapData.size, mapData.size, '#f3fa98', 'white');
            rect.index = i;
            if (i == mapData.squares.length - 1) {
                rect.meta = true;
            }

            game.addObject(rect)
        }

        // let circle = new Circle(350, 240, 28);
        // circle.setMass(10);
        // circle.elasticity = 0.7;

        // game.addObject(circle)

        // let cell = new Cell(340, 340, 20);
        // game.addObject(cell);
        // game.keyControl(cell)

        // let cells = [
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20)
        // ].forEach(c => game.addObject(c))
        let neuroevolution = new Neuroevolution(game);
        let timer = null;
        window.addEventListener('keydown', (e) => {

            if (e.key == ' ') {
                clearInterval(timer);
                neuroevolution.nextGeneration();
            }
            if (e.key == 'Enter') {
                neuroevolution.nextGeneration();
                timer = setInterval(() => {
                    neuroevolution.nextGeneration();
                }, 30000);
            }
        })

        window.setMutation = (rate) => {
            neuroevolution.mutationRate = rate;
        }

        let cell = new Cell();
        game.add(cell);

        setTimeout(() => {
            game.init();
            // console.log(game.objects);
        }, 500)


    </script>
</body>

</html>