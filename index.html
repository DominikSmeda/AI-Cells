<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cells</title>

    <style>
        * {
            box-sizing: border-box;
        }

        canvas {
            margin-top: 100px;
            border: 1px solid black;
            display: block;
            margin: 0 auto;

            image-rendering: crisp-edges;
            /* image-rendering: pixelated; */
        }

        #settings-switch {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background-color: black;
            border-radius: 4px;
            cursor: pointer;
        }

        #settings-switch .icon {
            font-size: 30px;
            color: white;
        }

        #settings {
            position: absolute;
            margin-left: auto;
            margin-right: auto;
            left: 0;
            right: 0;
            margin-top: 150px;
            width: 800px;
            height: 600px;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.556);
            border-radius: 4px;
            display: flex;
        }

        #settings #title {
            font-size: 22px;
            border-bottom: 2px solid black;
            padding: 5px 0;
        }

        #settings #maps {
            background-color: rgba(245, 245, 245, 0.748);
            width: 100%;
            padding: 10px;
            margin: 5px;
        }

        #settings #dnas {
            background-color: rgba(245, 245, 245, 0.748);
            width: 100%;
            padding: 10px;
            margin: 5px;
        }

        #settings .list {
            padding: 10px;
        }

        #settings .list .element {
            padding: 10px;
            border: 1px solid black;
            cursor: pointer;
            margin-bottom: 5px;
        }

        #settings .list .element:hover {
            background-color: rgba(0, 0, 0, 0.453);
            color: white
        }
    </style>
</head>

<body>
    <div id="settings-switch">
        <span class='icon'>&#9881;</span>
    </div>

    <div id="settings">
        <div id="maps">
            <div id="title">
                Uploaded Maps
            </div>
            <div class="list">

            </div>
        </div>
        <div id="dnas">
            <div id="title">
                Uploaded DNAs
            </div>
            <div class="list">

            </div>
        </div>
    </div>

    <div>
        <canvas id="root" width="900" height="900"></canvas>
    </div>


    <!-- <script src="./GameManager.js"></script> -->

    <script type="module">
        let showSettings = true;
        document.querySelector('#settings-switch').addEventListener('click', (e) => {
            if (showSettings)
                document.querySelector('#settings').style.visibility = "hidden";
            else
                document.querySelector('#settings').style.visibility = "visible";
            showSettings = !showSettings;
        })
        // alert();
        var KEYS = {};
        window.addEventListener('keydown', e => {
            KEYS[e.key] = true;
        })
        window.addEventListener('keyup', e => {
            KEYS[e.key] = false;
        })

        const width = 920, height = 900;
        ctx = document.getElementById('root').getContext('2d');

        import { Engine2D, Circle, Vector, Line, RayCast, Shapes } from './PhysicsEngine2DLib/main.js';
        import GameManager from './GameManager.js';
        import Cell from './Cell.js';
        import Neuroevolution from './Neuroevolution.js';

        const game = new GameManager();
        game.setCanvasSize(width, height);
        game.setCtx(ctx);


        // let line = new Line(0, 0, 0, height, 0.5, 'black');
        // game.addObject(line);
        // let line2 = new Line(0, 0, width, 0, 0.5, 'black');
        // game.addObject(line2);
        // let line3 = new Line(width, 0, width, height, 0.5, 'black');
        // game.addObject(line3);
        // let line4 = new Line(0, height, width, height, 0.5, 'black');
        // game.addObject(line4);

        // let lines = [
        //     // [0, height - 115, width, height - 115],
        //     [160, height - 100, width - 250, height - 100],
        //     //
        //     [160, 600, 400, 600],
        //     [700, 160, 280, 190],
        //     [0, 150, 600, 150, 0.97],
        //     [width, 600, 500, 700],
        //     [160, 300, 160, height - 100]
        // ]
        // for (let line of lines) {
        //     game.addObject(new Line(line[0], line[1], line[2], line[3], line[4], line[5]));
        // }

        let mapsData = [
            // `{"name":"","lines":[[0,0,150,0],[0,0,0,150],[150,0,150,150],[0,150,0,300],[150,150,150,300],[0,300,0,450],[150,300,150,450],[0,450,0,600],[150,450,150,600],[0,600,0,750],[150,600,150,750],[0,900,150,900],[0,750,0,900],[150,750,300,750],[150,900,300,900],[300,0,450,0],[300,0,300,150],[300,150,300,300],[450,150,450,300],[300,300,300,450],[450,300,450,450],[300,450,300,600],[450,450,450,600],[300,600,300,750],[450,600,450,750],[300,900,450,900],[450,750,450,900],[450,0,600,0],[450,150,600,150],[600,0,750,0],[750,0,750,150],[600,150,600,300],[750,150,750,300],[600,300,600,450],[750,300,750,450],[600,450,600,600],[750,450,750,600],[600,600,600,750],[750,600,750,750],[600,900,750,900],[600,750,600,900],[750,750,900,750],[750,900,900,900],[900,750,900,900]],"width":6,"height":6,"size":150,"squares":[{"x":75,"y":75},{"x":75,"y":225},{"x":75,"y":375},{"x":75,"y":525},{"x":75,"y":675},{"x":75,"y":825},{"x":225,"y":825},{"x":375,"y":825},{"x":375,"y":675},{"x":375,"y":525},{"x":375,"y":375},{"x":375,"y":225},{"x":375,"y":75},{"x":525,"y":75},{"x":675,"y":75},{"x":675,"y":225},{"x":675,"y":375},{"x":675,"y":525},{"x":675,"y":675},{"x":675,"y":825},{"x":825,"y":825}]}`,
            // '{"name":"","lines":[[0,0,150,0],[0,0,0,150],[150,0,150,150],[0,150,0,300],[150,150,150,300],[0,450,150,450],[0,300,0,450],[150,300,300,300],[150,450,300,450],[300,300,450,300],[450,300,450,450],[300,450,300,600],[450,450,450,600],[300,750,450,750],[300,600,300,750],[450,0,600,0],[450,0,450,150],[450,300,600,300],[450,150,450,300],[450,600,600,600],[450,750,600,750],[600,0,750,0],[600,150,750,150],[600,150,750,150],[750,150,750,300],[600,300,600,450],[750,300,750,450],[600,450,600,600],[750,450,750,600],[600,750,750,750],[750,600,750,750],[750,0,900,0],[750,150,900,150],[900,0,900,150]],"width":6,"height":6,"size":150,"squares":[{"x":75,"y":75},{"x":75,"y":225},{"x":75,"y":375},{"x":225,"y":375},{"x":375,"y":375},{"x":375,"y":525},{"x":375,"y":675},{"x":525,"y":675},{"x":675,"y":675},{"x":675,"y":525},{"x":675,"y":375},{"x":675,"y":225},{"x":525,"y":225},{"x":525,"y":75},{"x":675,"y":75},{"x":825,"y":75}]}',
            // '{"name":"","lines":[[0,0,112.5,0],[0,0,0,112.5],[112.5,0,112.5,112.5],[0,112.5,0,225],[112.5,112.5,112.5,225],[0,337.5,112.5,337.5],[0,225,0,337.5],[0,450,112.5,450],[0,450,0,562.5],[0,562.5,0,675],[112.5,562.5,112.5,675],[0,787.5,112.5,787.5],[0,675,0,787.5],[112.5,225,225,225],[112.5,337.5,225,337.5],[112.5,450,225,450],[112.5,562.5,225,562.5],[112.5,675,225,675],[112.5,787.5,225,787.5],[225,225,337.5,225],[337.5,225,337.5,337.5],[225,337.5,225,450],[337.5,337.5,337.5,450],[225,562.5,337.5,562.5],[337.5,450,337.5,562.5],[225,675,337.5,675],[337.5,675,337.5,787.5],[225,900,337.5,900],[225,787.5,225,900],[337.5,787.5,450,787.5],[337.5,900,450,900],[450,225,562.5,225],[450,225,450,337.5],[450,337.5,450,450],[562.5,337.5,562.5,450],[450,450,450,562.5],[562.5,450,562.5,562.5],[450,675,562.5,675],[450,562.5,450,675],[450,787.5,562.5,787.5],[450,900,562.5,900],[562.5,225,675,225],[562.5,337.5,675,337.5],[562.5,562.5,675,562.5],[562.5,675,675,675],[562.5,787.5,675,787.5],[562.5,900,675,900],[675,225,787.5,225],[787.5,225,787.5,337.5],[675,450,787.5,450],[675,337.5,675,450],[675,562.5,787.5,562.5],[787.5,562.5,787.5,675],[675,675,675,787.5],[787.5,675,787.5,787.5],[675,900,787.5,900],[787.5,787.5,787.5,900],[787.5,337.5,900,337.5],[787.5,450,900,450],[900,337.5,900,450]],"width":"8","height":"8","size":112.5,"squares":[{"x":56.25,"y":56.25},{"x":56.25,"y":168.75},{"x":56.25,"y":281.25},{"x":168.75,"y":281.25},{"x":281.25,"y":281.25},{"x":281.25,"y":393.75},{"x":281.25,"y":506.25},{"x":168.75,"y":506.25},{"x":56.25,"y":506.25},{"x":56.25,"y":618.75},{"x":56.25,"y":731.25},{"x":168.75,"y":731.25},{"x":281.25,"y":731.25},{"x":281.25,"y":843.75},{"x":393.75,"y":843.75},{"x":506.25,"y":843.75},{"x":618.75,"y":843.75},{"x":731.25,"y":843.75},{"x":731.25,"y":731.25},{"x":731.25,"y":618.75},{"x":618.75,"y":618.75},{"x":506.25,"y":618.75},{"x":506.25,"y":506.25},{"x":506.25,"y":393.75},{"x":506.25,"y":281.25},{"x":618.75,"y":281.25},{"x":731.25,"y":281.25},{"x":731.25,"y":393.75},{"x":843.75,"y":393.75}]}'
        ]

        let DNAs = []
        // mapsData = mapsData.map(data => JSON.parse(data));

        function loadMap(index) {
            game.objects = game.objects.filter(el => (el instanceof Cell) || (el instanceof Neuroevolution))
            // console.log(game.objects)
            let mapData = mapsData[index].mapData;
            for (let pos of mapData.lines) {
                let line = new Line(pos[0], pos[1], pos[2], pos[3], 0.5, 'black');
                game.addObject(line)
            }

            for (let i = 0; i < mapData.squares.length; i++) {
                let square = mapData.squares[i];

                let rect = new Shapes.Rectangle(square.x, square.y, mapData.size, mapData.size, '#f3fa98', 'white');
                rect.index = i;
                if (i == mapData.squares.length - 1) {
                    rect.meta = true;
                }

                game.addObject(rect)
            }
        }


        // let circle = new Circle(350, 240, 28);
        // circle.setMass(10);
        // circle.elasticity = 0.7;

        // game.addObject(circle)

        // let cell = new Cell(340, 340, 20);
        // game.addObject(cell);
        // game.keyControl(cell)

        // let cells = [
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20),
        //     new Cell(640, 40, 20)
        // ].forEach(c => game.addObject(c))
        let neuroevolution = new Neuroevolution(game);

        let timer = null;
        window.addEventListener('keydown', (e) => {

            if (e.key == ' ') {
                clearInterval(timer);
                neuroevolution.nextGeneration();
            }
            if (e.key == 'Enter') {
                clearInterval(timer);
                neuroevolution.nextGeneration();
                timer = setInterval(() => {
                    neuroevolution.nextGeneration();
                }, 12000);
            }
        })

        window.setMutationRate = (rate) => {
            neuroevolution.mutationRate = rate;
        }

        window.setPopulationQuantity = (quantity) => {
            neuroevolution.populationQuantity = quantity;
        }

        window.loadMap = (index) => {
            loadMap(index);
        }

        window.saveBest = (name, amount = 1) => {
            let DNAs = neuroevolution.saveBest(amount);
            console.log(DNAs)

            let sendData = {
                name: name,
                brain: DNAs[0].brain
            }

            fetch('http://localhost:3000/brain', {
                method: 'POST',
                body: JSON.stringify(sendData),
                headers: {
                    'Content-Type': 'application/json'
                },
            })
        }

        function downloadMaps() {
            fetch('http://localhost:3000/map')
                .then(r => r.json())
                .then(data => {
                    // console.log(data.maps)
                    mapsData = data.maps;

                    let mapList = document.querySelector('#settings #maps .list');

                    let i = 0;
                    for (let map of mapsData) {
                        let elem = document.createElement('div');
                        elem.innerHTML = `<div id="${i++}"class='element'>${map.name}</div>`;
                        elem.onclick = (e) => {
                            loadMap(e.target.id);
                        }

                        mapList.appendChild(elem);
                    }

                })
        }
        downloadMaps();

        function downloadDNAs() {
            fetch('http://localhost:3000/brain')
                .then(r => r.json())
                .then(data => {

                    DNAs = data.brains;

                    let dnaList = document.querySelector('#settings #dnas .list');

                    let i = 0;
                    for (let dna of DNAs) {
                        let elem = document.createElement('div');
                        elem.innerHTML = `<div id="${i++}"class='element'>${dna.name}</div>`;
                        elem.onclick = (e) => {
                            // loadMap(e.target.id);
                            neuroevolution.load(DNAs[e.target.id])
                        }

                        dnaList.appendChild(elem);
                    }

                })
        }
        downloadDNAs();


        setTimeout(() => {

            game.addObject(neuroevolution)
            // console.log(game.objects)
            game.init();
            loadMap(0)

            // console.log(game.objects);
        }, 500)


    </script>
</body>

</html>